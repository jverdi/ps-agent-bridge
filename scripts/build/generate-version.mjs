#!/usr/bin/env node
import { mkdirSync, readFileSync, writeFileSync } from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const scriptDir = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(scriptDir, "../..");
const packageJsonPath = path.join(repoRoot, "package.json");
const outputPath = path.join(repoRoot, "psagent", "src", "core", "version.generated.ts");

const packageJson = JSON.parse(readFileSync(packageJsonPath, "utf8"));
const version = typeof packageJson.version === "string" ? packageJson.version.trim() : "";

if (!version) {
  console.error("Unable to read package version from package.json");
  process.exit(1);
}

const nextSource = `// Auto-generated by scripts/build/generate-version.mjs. Do not edit manually.
export const VERSION = ${JSON.stringify(version)};
`;

let currentSource = "";
try {
  currentSource = readFileSync(outputPath, "utf8");
} catch {
  // First run or missing file.
}

if (currentSource !== nextSource) {
  mkdirSync(path.dirname(outputPath), { recursive: true });
  writeFileSync(outputPath, nextSource, "utf8");
  console.log(`Synced CLI version constant to ${version}`);
}
